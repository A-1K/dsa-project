<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSA Weather Dashboard</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* KEEP ALL CSS FROM PREVIOUS VERSION */
        :root { --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); --glass-bg: rgba(15, 23, 42, 0.65); --glass-border: rgba(255, 255, 255, 0.1); --text-primary: #ffffff; --text-secondary: #94a3b8; --accent-color: #3b82f6; --chart-grid: rgba(255, 255, 255, 0.1); --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        [data-theme="light"] { --bg-gradient: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%); --glass-bg: rgba(255, 255, 255, 0.60); --glass-border: rgba(255, 255, 255, 0.4); --text-primary: #1e293b; --text-secondary: #64748b; --accent-color: #2563eb; --chart-grid: rgba(0, 0, 0, 0.1); --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); }
        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-gradient); color: var(--text-primary); height: 100vh; overflow: hidden; transition: background 0.5s ease; }
        .app-container { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
        .sidebar { background: var(--glass-bg); backdrop-filter: blur(20px); border-right: 1px solid var(--glass-border); padding: 25px; display: flex; flex-direction: column; justify-content: space-between; }
        .nav-links { display: flex; flex-direction: column; gap: 12px; }
        .sidebar-title { font-size: 0.75rem; letter-spacing: 1.5px; font-weight: 700; color: var(--text-secondary); margin-bottom: 20px; text-transform: uppercase;}
        .city-btn { padding: 14px 18px; border-radius: 12px; cursor: pointer; transition: all 0.2s; font-weight: 500; display: flex; align-items: center; justify-content: space-between; color: var(--text-secondary); }
        .city-btn:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); transform: translateX(5px); }
        .city-btn.active { background: var(--accent-color); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
        .theme-toggle { padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-primary); transition: background 0.2s; }
        .main-content { padding: 30px 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; }
        .header-section { text-align: center; margin-bottom: 10px; }
        .header-section h1 { font-size: 2.5rem; margin: 0; font-weight: 300; }
        .header-section h2 { font-size: 5rem; margin: 0; font-weight: 600; letter-spacing: -2px; line-height: 1; }
        .header-section p { font-size: 1.5rem; color: var(--text-secondary); margin-top: 5px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .card { background: var(--glass-bg); box-shadow: var(--shadow); backdrop-filter: blur(20px); border-radius: 20px; padding: 20px; border: 1px solid var(--glass-border); transition: transform 0.2s; }
        .section-header { display: flex; align-items: center; justify-content: space-between; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; }
        .graph-controls { display: flex; gap: 5px; }
        .time-btn { background: transparent; border: 1px solid var(--glass-border); color: var(--text-secondary); padding: 5px 12px; border-radius: 8px; cursor: pointer; font-size: 0.75rem; font-weight: 600; transition: all 0.2s; }
        .time-btn:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        .time-btn.active { background: var(--accent-color); color: white; border-color: transparent; }
        .graph-wrapper { height: 180px; width: 100%; }
        .split-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        #cityMap { height: 320px; width: 100%; border-radius: 16px; z-index: 1; }
        .daily-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--glass-border); }
        .daily-row:last-child { border-bottom: none; }
        .daily-icon { font-size: 1.2rem; width: 30px; text-align: center; }
        .temp-high { font-weight: 700; color: var(--text-primary); }
        .temp-low { color: var(--text-secondary); }
        .details-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .detail-item { height: 140px; display: flex; flex-direction: column; justify-content: space-between; }
        .detail-val { font-size: 2.2rem; font-weight: 600; }
        .detail-label { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; }
    </style>
</head>
<body>
    <div class="app-container">
    <div class="sidebar">
        <div class="nav-links">
            <div class="sidebar-title">Locations</div>
            <div class="city-btn" onclick="loadCity('Islamabad')"><span>Islamabad</span> <i class="fas fa-chevron-right"></i></div>
            <div class="city-btn" onclick="loadCity('Lahore')"><span>Lahore</span> <i class="fas fa-chevron-right"></i></div>
            <div class="city-btn" onclick="loadCity('Karachi')"><span>Karachi</span> <i class="fas fa-chevron-right"></i></div>
            <div class="city-btn" onclick="loadCity('Topi')"><span>Topi</span> <i class="fas fa-chevron-right"></i></div>
            <div class="city-btn" onclick="loadCity('Seraikistan')"><span>Seraikistan</span> <i class="fas fa-chevron-right"></i></div>
        </div>
        <div class="theme-toggle" onclick="toggleTheme()">
            <i class="fas fa-adjust" id="theme-icon"></i>
            <span id="theme-text">Switch Mode</span>
        </div>
    </div>
    <div class="main-content">
        <div class="header-section">
            <h1 id="ui-city">Topi</h1>
            <h2 id="ui-temp">--Â°</h2>
            <p id="ui-condition">Loading...</p>
        </div>
        <div class="card">
            <div class="section-header">
                <span id="graph-title"><i class="fas fa-clock"></i> Forecast Trends (Backend Data)</span>
                <div class="graph-controls">
                    <button class="time-btn active" onclick="switchGraph('hourly', this)">24H</button>
                    <button class="time-btn" onclick="switchGraph('weekly', this)">Week</button>
                    <button class="time-btn" onclick="switchGraph('monthly', this)">Month</button>
                    <button class="time-btn" onclick="switchGraph('yearly', this)">Year</button>
                </div>
            </div>
            <div class="graph-wrapper">
                <canvas id="hourlyChart"></canvas>
            </div>
        </div>
        <div class="split-grid">
            <div class="card" style="padding:0; overflow:hidden;"><div id="cityMap"></div></div>
            <div class="card" style="overflow-y: auto; max-height: 320px;">
                <div class="section-header"><i class="fas fa-calendar-alt"></i> 10-Day Forecast</div>
                <div id="daily-list"></div>
            </div>
        </div>
        <div class="details-grid">
            <div class="card detail-item"><div class="detail-label"><i class="fas fa-wind"></i> Wind</div><div class="detail-val" id="ui-wind">--</div><div style="font-size: 0.9rem; color: var(--text-secondary)">Direction: ENE</div></div>
            <div class="card detail-item"><div class="detail-label"><i class="fas fa-tint"></i> Humidity</div><div class="detail-val" id="ui-hum">--</div><div style="font-size: 0.9rem; color: var(--text-secondary)">Dew Point: 5Â°</div></div>
            <div class="card detail-item"><div class="detail-label"><i class="fas fa-eye"></i> Visibility</div><div class="detail-val">20 km</div><div style="font-size: 0.9rem; color: var(--text-secondary)">Perfect view</div></div>
        </div>
    </div>
</div>

<script>
    let map = null, marker = null, hourlyChart = null;
    let isDarkMode = true;
    let cachedData = {}; // Store the C++ data here for switching graphs instantly

    function getWeatherEmoji(condition) {
        const cond = condition.toLowerCase();
        if (cond.includes('clear') || cond.includes('sunny')) return 'â˜€ï¸';
        if (cond.includes('rain')) return 'ðŸŒ§ï¸';
        if (cond.includes('cloud')) return 'â˜ï¸';
        if (cond.includes('wind')) return 'ðŸ’¨';
        if (cond.includes('hot') || cond.includes('scorching')) return 'ðŸŒ¡ï¸';
        return 'ðŸŒ¤ï¸';
    }

    function toggleTheme() {
        isDarkMode = !isDarkMode;
        document.body.toggleAttribute('data-theme');
        document.getElementById('theme-text').innerText = isDarkMode ? "Switch Mode" : "Switch Back";
        refreshMapTiles();
    }

    function initMap(lat, lon) {
        if(map) return;
        map = L.map('cityMap', { zoomControl: false }).setView([lat, lon], 10);
        refreshMapTiles();
    }

    function refreshMapTiles() {
        if(!map) return;
        map.eachLayer(l => { if (l instanceof L.TileLayer) map.removeLayer(l); });
        const tileUrl = isDarkMode ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        L.tileLayer(tileUrl, { attribution: '&copy; OpenStreetMap' }).addTo(map);
    }

    function updateMap(lat, lon, title) {
        if (!map) initMap(lat, lon);
        map.flyTo([lat, lon], 10);
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lon]).addTo(map).bindPopup(title).openPopup();
    }

    function switchGraph(mode, btn) {
        document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        
        // --- FETCH FROM CACHE (DATA PROVIDED BY C++) ---
        let data = [];
        let labels = [];

        if (mode === 'hourly') {
            data = cachedData.hourly || [];
            labels = Array.from({length: data.length}, (_, i) => `${i}:00`);
        } else if (mode === 'weekly') {
            data = cachedData.weekly || [];
            labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        } else if (mode === 'monthly') {
            data = cachedData.monthly || [];
            labels = Array.from({length: data.length}, (_, i) => `Day ${i+1}`);
        } else if (mode === 'yearly') {
            data = cachedData.yearly || [];
            labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        }

        renderChart(labels, data);
    }

    function renderChart(labels, data) {
        const ctx = document.getElementById('hourlyChart').getContext('2d');
        if(hourlyChart) hourlyChart.destroy();
        
        hourlyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Temp',
                    data: data,
                    borderColor: '#facc15',
                    borderWidth: 3,
                    tension: 0.4,
                    pointBackgroundColor: '#facc15',
                    fill: false
                }]
            },
            plugins: [ChartDataLabels],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: {display:false}, datalabels: { align: 'top', color: 'gray', formatter: v => v+'Â°' } },
                scales: { x: { grid: {display:false} }, y: { display:false, min: Math.min(...data)-5, max: Math.max(...data)+5 } }
            }
        });
    }

    function renderDaily(forecastArray) {
        const list = document.getElementById('daily-list');
        let html = '';
        forecastArray.forEach(d => {
            let icon = getWeatherEmoji(d.cond);
            html += `
                <div class="daily-row">
                    <div style="width: 50px;">${d.day}</div>
                    <div class="daily-icon">${icon}</div>
                    <div class="temp-low">${d.low}Â°</div>
                    <div style="width: 80px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px;">
                        <div style="width: 60%; height: 100%; background: #facc15; border-radius: 2px;"></div>
                    </div>
                    <div class="temp-high">${d.high}Â°</div>
                </div>`;
        });
        list.innerHTML = html;
    }

    async function loadCity(cityName) {
        try {
            document.querySelectorAll('.city-btn').forEach(b => {
                b.classList.remove('active');
                if(b.innerText.includes(cityName)) b.classList.add('active');
            });

            const res = await fetch(`/data?city=${cityName}`);
            const data = await res.json();
            
            if(!data.city) return;

            // --- CACHE THE VECTORS FROM C++ ---
            cachedData = data; 

            document.getElementById('ui-city').innerText = data.city;
            document.getElementById('ui-temp').innerText = data.current.temperature_2d + "Â°";
            document.getElementById('ui-condition').innerHTML = getWeatherEmoji(data.current.condition) + " " + data.current.condition;
            document.getElementById('ui-wind').innerText = data.current.wind_speed_10m + " km/h";
            document.getElementById('ui-hum').innerText = data.current.relative_humidity_2d + "%";

            updateMap(data.lat, data.lon, data.city);
            
            // Initial Views
            switchGraph('hourly', document.querySelector('.time-btn')); // Default to hourly
            renderDaily(data.forecast); // Use C++ Daily Forecast Vector

        } catch(e) { console.error(e); }
    }

    window.onload = () => { initMap(34.07, 72.6); loadCity('Topi'); };
</script>
</body>
</html>